<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥ååŒå - æ¢³é£å¼„å¼¦éŸ³</title>
    <style>
        /* é˜¿é‡Œå¦ˆå¦ˆä¸œæ–¹å¤§æ¥·å­—ä½“å£°æ˜ */
        @font-face {
        font-family: 'AlimamaDongFangDaKai';
        src: url('fonts/AlimamaDongFangDaKai-Regular.otf') format('opentype'),
            url('fonts/AlimamaDongFangDaKai-Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'AlimamaDongFangDaKai', "SimHei", "Microsoft YaHei", sans-serif;     /* ä¿®æ”¹ä¸ºé˜¿é‡Œå¦ˆå¦ˆ */
        }

        body {
            background-color: #f9f7f3;
            color: #5a4b38;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* æ ‡é¢˜åŒº */
        .page-header {
            text-align: center;
            padding: 50px 0 30px;
            border-bottom: 1px solid #e0d8c8;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 2.2rem;
            color: #5a4b38;
            font-weight: 400;
            letter-spacing: 6px;
        }

        .team-name {
            margin-top: 8px;
            font-size: 1rem;
            color: #8a7d6b;
        }

        /* é˜Ÿé•¿å¡«å†™åŒºåŸŸæ ‡é¢˜ */
        .raid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #9a8868;
        }

        .raid-title {
            font-size: 1.2rem;
            color: #5a4b38;
            font-weight: 500;
        }

        .header-save-btn {
            padding: 8px 20px;
            background-color: #9a8868;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.3s;
            margin-left: 15px; /* å¢åŠ å·¦ä¾§é—´è· */
        }

        .header-save-btn:hover {
            background-color: #867352;
        }

        /* æ‰“æœ¬ä¿¡æ¯æ æ ·å¼ */
        .raid-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0d8c8;
            flex-wrap: wrap;
        }

        .info-item {
            flex: 1;
            min-width: 180px;
        }

        .info-label {
            display: block;
            font-size: 0.9rem;
            color: #8a7d6b;
            margin-bottom: 6px;
        }

        .day-select, .time-select, .copy-select, .remark-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0d8c8;
            border-radius: 6px;
            font-size: 1rem;
            background: #fefbf7;
            outline: none;
            color: #5a4b38;
        }

        .day-select:focus, .time-select:focus, .copy-select:focus, .remark-input:focus {
            border-color: #9a8868;
        }

        /* åˆ—è¡¨é¡¹ */
        .item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 14px 18px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0d8c8;
        }

        .prefix {
            width: 100px;
            font-size: 1rem;
            color: #5a4b38;
            font-weight: 500;
        }

        .fixed-text {
            font-size: 1rem;
            color: #5a4b38;
        }

        .input-box {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0d8c8;
            border-radius: 6px;
            font-size: 1rem;
            background: #fefbf7;
            outline: none;
        }

        .input-box:focus {
            border-color: #9a8868;
        }

        /* æŒ‰é’® */
        .btn {
            margin-left: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .save-btn {
            background: #9a8868;
            color: #fff;
        }

        .del-btn {
            background: #c9b89f;
            color: #fff;
        }

        /* æç¤ºæ¡†æ ·å¼ */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #d64141;
            color: white;
            border-radius: 6px;
            z-index: 9999;
            display: none;
            animation: fadeInOut 3s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            80% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .raid-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-save-btn {
                margin-left: 0;
                margin-top: 10px; /* å¢åŠ ä¸Šæ–¹é—´è· */
                width: auto; /* ä¸è¦å…¨å®½åº¦ */
                min-width: 120px; /* è®¾ç½®æœ€å°å®½åº¦ */
                align-self: flex-end;
            }
            
            .raid-info {
                flex-direction: column;
                gap: 12px;
            }

            .info-item {
                min-width: 100%;
            }

            .item {
                flex-wrap: wrap;
            }
            .prefix {
                width: 80px;
                margin-bottom: 8px;
            }
            .input-box {
                width: 100%;
                margin-bottom: 8px;
            }
            .btn {
                margin-left: 0;
                margin-right: 8px;
                margin-top: 8px;   /* æ·»åŠ ä¸Šæ–¹å¤–è¾¹è·ï¼Œä¸è¾“å…¥æ¡†ä¿æŒè·ç¦» */
            }
            
            /* æ–°å¢ï¼šç¡®ä¿ä¿å­˜æŒ‰é’®å’Œåˆ é™¤æŒ‰é’®åœ¨åŒä¸€ä½ç½® */
            .save-btn, .del-btn {
                margin-left: 8px;
                margin-right: 8px;
                margin-top: 8px;
            }
            
            /* å¯é€‰ï¼šä¸ºæŒ‰é’®å®¹å™¨æ·»åŠ flexå¸ƒå±€ï¼Œä½¿æŒ‰é’®æ’åˆ—æ›´æ•´é½ */
            .item {
                position: relative;
            }
            
            .btn {
                display: inline-block;
            }
        }
    </style>
    
    <!-- Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ– -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script>
        // æ›¿æ¢ä¸ºæ‚¨çš„å®é™…Supabaseé¡¹ç›®URLå’ŒAnon Key
        const SUPABASE_URL = 'https://jtxbzkfnpbrjmlqinogj.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_0K0RV2KcU7DkuSxF9t73dA_a8pIZnB3';
        
        // åˆ›å»ºSupabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // æµ‹è¯•è¿æ¥
        supabase.from('team_members').select('*').limit(1)
            .then(response => {
                console.log('Supabaseè¿æ¥æˆåŠŸ:', response);
            })
            .catch(error => {
                console.error('Supabaseè¿æ¥å¤±è´¥:', error);
            });
    </script>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">æŠ¥ååŒå</h1>
            <div class="team-name">é˜Ÿä¼ï¼šæ¯”é—¨</div>
        </div>

        <!-- æç¤ºæ¡† -->
        <div class="alert" id="alertBox">è¯¥ä½ç½®å·²ç»è¢«å¡«å†™ï¼è¯·åœ¨ä¸‹æ–¹é‡æ–°å¡«å†™ã€‚</div>

        <!-- æ‰“æœ¬ä¿¡æ¯æ ï¼ˆé˜Ÿé•¿è¡Œä¸Šæ–¹ï¼‰ -->
        <div class="raid-header">
            <div class="raid-title">æœ¬æ ä»…é˜Ÿé•¿å¡«å†™ï¼Œä¿å­˜ç”Ÿæ•ˆ</div>
            <button class="header-save-btn" id="headerSaveBtn">ä¿å­˜è®¾ç½®</button>
        </div>
        
        <div class="raid-info" id="raidInfo">
            <!-- æ˜ŸæœŸé€‰æ‹©å™¨ -->
            <div class="info-item">
                <label class="info-label">é€‰æ‹©æ˜ŸæœŸ</label>
                <select class="day-select" id="daySelector">
                    <option value="å‘¨ä¸€">å‘¨ä¸€</option>
                    <option value="å‘¨äºŒ">å‘¨äºŒ</option>
                    <option value="å‘¨ä¸‰">å‘¨ä¸‰</option>
                    <option value="å‘¨å››">å‘¨å››</option>
                    <option value="å‘¨äº”">å‘¨äº”</option>
                    <option value="å‘¨å…­">å‘¨å…­</option>
                    <option value="å‘¨æ—¥">å‘¨æ—¥</option>
                </select>
            </div>

            <!-- æ‰“æœ¬æ—¶é—´é€‰æ‹©å™¨ -->
            <div class="info-item">
                <label class="info-label">æ‰“æœ¬æ—¶é—´</label>
                <select class="time-select" id="timeSelector">
                    <!-- è‡ªåŠ¨ç”Ÿæˆ0~24:00ï¼ŒåŠå°æ—¶ä¸ºå•ä½çš„é€‰é¡¹ -->
                </select>
            </div>

            <!-- å‰¯æœ¬é€‰æ‹©ä¸‹æ‹‰èœå• -->
            <div class="info-item">
                <label class="info-label">å‰¯æœ¬é€‰æ‹©</label>
                <select class="copy-select" id="copySelector">
                    <option value="åŒå">åŒå</option>
                    <option value="å¼€è’">å¼€è’</option>
                </select>
            </div>

            <!-- å¤‡æ³¨è¾“å…¥æ¡† -->
            <div class="info-item">
                <label class="info-label">é˜Ÿé•¿æœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼š</label>
                <input type="text" class="remark-input" id="remarkInput" placeholder="è¯·è¾“å…¥">
            </div>
        </div>

        <div class="raid-header" style="margin-top: 30px;">
            <div class="raid-title">é˜Ÿå‘˜å¡«å†™ï¼Œä¿å­˜ç”Ÿæ•ˆ</div>
            <button class="header-save-btn" id="clearAllBtn">ä¸€é”®æ¸…ç©º</button>
        </div>

        <!-- é˜Ÿé•¿ï¼ˆå›ºå®šï¼‰ -->
        <div class="item">
            <div class="prefix">é˜Ÿé•¿</div>
            <div class="fixed-text">æ¯”æ ¼</div>
        </div>

        <!-- é˜Ÿå‘˜ 1-7ã€çº¯å¥¶ä½ 1-2 ç»“æ„ä¸å˜ -->
        <div class="item" data-id="member1">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member2">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member3">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member4">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member5">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member6">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="member7">
            <div class="prefix">é˜Ÿå‘˜</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="milk1">
            <div class="prefix">çº¯å¥¶ä½</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
        <div class="item" data-id="milk2">
            <div class="prefix">çº¯å¥¶ä½</div>
            <input type="text" class="input-box" placeholder="è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜">
            <button class="btn save-btn">ä¿å­˜</button>
            <button class="btn del-btn" style="display: none;">åˆ é™¤</button>
        </div>
    </div>

    <script>
        // å­˜å‚¨å·²å¡«å†™çš„ä½ç½®ä¿¡æ¯
        const filledPositions = {};
        const alertBox = document.getElementById('alertBox');
        const TEAM_KEY = 'bige'; // æ¯”é—¨é˜Ÿä¼æ ‡è¯†
        const RAID_SETTINGS_KEY = `${TEAM_KEY}_raid_settings`; // æ‰“æœ¬è®¾ç½®å­˜å‚¨é”®

        // ç”Ÿæˆæ—¶é—´é€‰æ‹©å™¨é€‰é¡¹ï¼ˆ0~24:00ï¼ŒåŠå°æ—¶ä¸ºå•ä½ï¼‰
        function generateTimeOptions() {
            const timeSelector = document.getElementById('timeSelector');
            
            // é¦–å…ˆæ·»åŠ "ç™¾ä¸šæ´¾å¯¹å"é€‰é¡¹å¹¶è®¾ç½®ä¸ºé»˜è®¤é€‰ä¸­
            const afterPartyOption = document.createElement('option');
            afterPartyOption.value = 'ç™¾ä¸šæ´¾å¯¹å';
            afterPartyOption.textContent = 'ç™¾ä¸šæ´¾å¯¹å';
            afterPartyOption.selected = true;
            timeSelector.appendChild(afterPartyOption);
            
            // æ·»åŠ åˆ†éš”çº¿é€‰é¡¹ï¼ˆå¯é€‰ï¼‰
            const separatorOption = document.createElement('option');
            separatorOption.disabled = true;
            separatorOption.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
            timeSelector.appendChild(separatorOption);
            
            let hours = 0;
            let minutes = 0;

            // ç”Ÿæˆ00:00åˆ°24:00çš„é€‰é¡¹ï¼Œæ­¥é•¿30åˆ†é’Ÿ
            while (hours <= 24) {
                const hourStr = hours.toString().padStart(2, '0');
                const minStr = minutes.toString().padStart(2, '0');
                const timeStr = `${hourStr}:${minStr}`;
                
                const option = document.createElement('option');
                option.value = timeStr;
                option.textContent = timeStr;
                timeSelector.appendChild(option);

                minutes += 30;
                if (minutes >= 60) {
                    minutes = 0;
                    hours += 1;
                }
            }
        }

        // åŠ è½½ä¿å­˜çš„æ‰“æœ¬ä¿¡æ¯
        function loadRaidInfo() {
            const savedInfo = localStorage.getItem(RAID_SETTINGS_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                if (info.day) document.getElementById('daySelector').value = info.day;
                if (info.time) document.getElementById('timeSelector').value = info.time;
                if (info.copy) document.getElementById('copySelector').value = info.copy;
                if (info.remark) document.getElementById('remarkInput').value = info.remark;
            } else {
                // é»˜è®¤è®¾ç½®ï¼šå‘¨ä¸€ 21:00 åŒå
                document.getElementById('daySelector').value = 'å‘¨ä¸€';
                document.getElementById('timeSelector').value = '21:00';
                document.getElementById('copySelector').value = 'åŒå';
            }
        }

        // ä¿å­˜æ‰“æœ¬è®¾ç½®
        async function saveRaidSettings() {
            const saveBtn = document.getElementById('headerSaveBtn');
            const raidSettings = {
                day: document.getElementById('daySelector').value,
                time: document.getElementById('timeSelector').value,
                copy_type: document.getElementById('copySelector').value,
                remark: document.getElementById('remarkInput').value
            };
            
            // 1. ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                day: raidSettings.day,
                time: raidSettings.time,
                copy: raidSettings.copy_type,
                remark: raidSettings.remark
            }));
            
            try {
                // 2. å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨è®°å½•
                const { data: existingRecord, error: checkError } = await supabase
                    .from('raid_settings')
                    .select('id')
                    .eq('team_key', TEAM_KEY)
                    .maybeSingle();
                
                let result;
                
                if (checkError) {
                    console.warn('æ£€æŸ¥è®°å½•æ—¶å‡ºé”™:', checkError);
                }
                
                // 3. æ ¹æ®æ˜¯å¦å­˜åœ¨è®°å½•é€‰æ‹©æ“ä½œ
                if (existingRecord) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    const { data, error } = await supabase
                        .from('raid_settings')
                        .update({
                            day: raidSettings.day,
                            time: raidSettings.time,
                            copy_type: raidSettings.copy_type,
                            remark: raidSettings.remark,
                            updated_at: new Date().toISOString()
                        })
                        .eq('team_key', TEAM_KEY)
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    console.log('æ›´æ–°æˆåŠŸ:', data);
                } else {
                    // æ’å…¥æ–°è®°å½•
                    const { data, error } = await supabase
                        .from('raid_settings')
                        .insert({
                            team_key: TEAM_KEY,
                            day: raidSettings.day,
                            time: raidSettings.time,
                            copy_type: raidSettings.copy_type,
                            remark: raidSettings.remark,
                            updated_at: new Date().toISOString()
                        })
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    console.log('æ’å…¥æˆåŠŸ:', data);
                }
                
                // 4. æ˜¾ç¤ºæˆåŠŸåé¦ˆ
                const originalText = saveBtn.textContent;
                const originalColor = saveBtn.style.color || '#000000';
                const originalBackground = saveBtn.style.backgroundColor;
                
                saveBtn.textContent = "å·²ä¿å­˜";
                saveBtn.style.color = "#4CAF50";
                saveBtn.style.backgroundColor = "#e8f5e9";
                
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.color = originalColor;
                    saveBtn.style.backgroundColor = originalBackground;
                }, 3000);
                
                alert('è®¾ç½®å·²ä¿å­˜åˆ°äº‘ç«¯ï¼');
                return result;
                
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                saveBtn.textContent = "ä¿å­˜å¤±è´¥";
                saveBtn.style.color = "#f44336";
                saveBtn.style.backgroundColor = "#ffebee";
                
                setTimeout(() => {
                    saveBtn.textContent = "ä¿å­˜è®¾ç½®";
                    saveBtn.style.color = "";
                    saveBtn.style.backgroundColor = "";
                }, 3000);
                
                alert('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä½†è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showAlert() {
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        // ä¿å­˜é˜Ÿå‘˜åŠŸèƒ½
        async function handleSave(event) {
            const btn = event.target;
            const item = btn.closest('.item');
            const input = item.querySelector('.input-box');
            const delBtn = item.querySelector('.del-btn');
            const positionId = item.dataset.id;

            const name = input.value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åå­—åå†ä¿å­˜ï¼');
                return;
            }

            if (filledPositions[positionId]) {
                showAlert();
                input.value = '';
                return;
            }

            try {
                // ä¿å­˜åˆ°Supabaseäº‘ç«¯æ•°æ®åº“
                const { data, error } = await supabase
                    .from('team_members')
                    .upsert({
                        team_key: TEAM_KEY,
                        position_id: positionId,
                        member_name: name
                    })
                    .select();

                if (error) {
                    console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
                    localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                    alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                } else {
                    console.log('ä¿å­˜åˆ°äº‘ç«¯æˆåŠŸ:', data);
                    localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                }
            } catch (err) {
                console.error('ä¿å­˜å¼‚å¸¸:', err);
                localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
            }

            filledPositions[positionId] = name;

            const fixedText = document.createElement('div');
            fixedText.className = 'fixed-text';
            fixedText.textContent = name;
            input.replaceWith(fixedText);

            btn.style.display = 'none';
            delBtn.style.display = 'inline-block';
        }

        // åˆ é™¤é˜Ÿå‘˜åŠŸèƒ½
        async function handleDelete(event) {
            const btn = event.target;
            const item = btn.closest('.item');
            const fixedText = item.querySelector('.fixed-text');
            const saveBtn = item.querySelector('.save-btn');
            const positionId = item.dataset.id;

            try {
                // ä»äº‘ç«¯åˆ é™¤
                const { error } = await supabase
                    .from('team_members')
                    .delete()
                    .eq('team_key', TEAM_KEY)
                    .eq('position_id', positionId);

                if (error) {
                    console.error('ä»äº‘ç«¯åˆ é™¤å¤±è´¥:', error);
                } else {
                    console.log('ä»äº‘ç«¯åˆ é™¤æˆåŠŸ');
                }
            } catch (err) {
                console.error('åˆ é™¤å¼‚å¸¸:', err);
            }

            // æ— è®ºäº‘ç«¯æ˜¯å¦æˆåŠŸï¼Œéƒ½åˆ é™¤æœ¬åœ°æ•°æ®
            delete filledPositions[positionId];
            localStorage.removeItem(`${TEAM_KEY}_${positionId}`);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-box';
            input.placeholder = 'è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜';
            fixedText.replaceWith(input);

            btn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        }

        // æ¸…ç©ºæ‰€æœ‰é˜Ÿå‘˜å¡«å†™çš„å†…å®¹
        async function clearAllInputs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é˜Ÿå‘˜å¡«å†™çš„å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¼šä»äº‘ç«¯æ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const clearBtn = document.getElementById('clearAllBtn');
                const originalText = clearBtn.textContent;
                clearBtn.textContent = 'æ¸…ç©ºä¸­...';
                clearBtn.disabled = true;
                
                // ç¬¬ä¸€æ­¥ï¼šä»äº‘ç«¯åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
                console.log('å¼€å§‹ä»äº‘ç«¯åˆ é™¤æ•°æ®...');
                
                // 1. åˆ é™¤ team_members è¡¨ä¸­è¯¥é˜Ÿä¼çš„æ‰€æœ‰è®°å½•
                const { error: membersError } = await supabase
                    .from('team_members')
                    .delete()
                    .eq('team_key', TEAM_KEY);
                
                if (membersError) {
                    console.error('åˆ é™¤äº‘ç«¯é˜Ÿå‘˜æ•°æ®å¤±è´¥:', membersError);
                    alert('åˆ é™¤äº‘ç«¯é˜Ÿå‘˜æ•°æ®å¤±è´¥: ' + membersError.message);
                    clearBtn.textContent = originalText;
                    clearBtn.disabled = false;
                    return;
                }
                
                console.log('äº‘ç«¯é˜Ÿå‘˜æ•°æ®åˆ é™¤æˆåŠŸ');
                
                // ç¬¬äºŒæ­¥ï¼šæ¸…é™¤æœ¬åœ°æ•°æ®å’Œç•Œé¢
                const items = document.querySelectorAll('.item');
                let clearedCount = 0;
                
                items.forEach(item => {
                    const positionId = item.dataset.id;
                    
                    // ä»…å¤„ç†é˜Ÿå‘˜å’Œå¥¶ä½ï¼ˆæœ‰data-idçš„é¡¹ç›®ï¼‰
                    if (positionId && (positionId.startsWith('member') || positionId.startsWith('milk'))) {
                        // åˆ é™¤æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem(`${TEAM_KEY}_${positionId}`);
                        
                        // æ¸…é™¤å†…å­˜è®°å½•
                        delete filledPositions[positionId];
                        
                        // æ‰¾åˆ°è¾“å…¥æ¡†å¹¶æ¸…é™¤
                        const inputBox = item.querySelector('.input-box');
                        if (inputBox) {
                            inputBox.value = '';
                        }
                        
                        // å¦‚æœå·²ç»ä¿å­˜ï¼Œéœ€è¦é‡ç½®ä¸ºå¯ç¼–è¾‘çŠ¶æ€
                        const fixedText = item.querySelector('.fixed-text');
                        if (fixedText) {
                            // åˆ›å»ºæ–°çš„è¾“å…¥æ¡†
                            const newInput = document.createElement('input');
                            newInput.type = 'text';
                            newInput.className = 'input-box';
                            newInput.placeholder = 'è¯·é˜Ÿå‘˜è‡ªè¡Œå¡«å†™åä¿å­˜';
                            
                            // æ›¿æ¢fixed-text
                            fixedText.replaceWith(newInput);
                            
                            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®ï¼Œéšè—åˆ é™¤æŒ‰é’®
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');
                            if (saveBtn) saveBtn.style.display = 'inline-block';
                            if (delBtn) delBtn.style.display = 'none';
                            
                            clearedCount++;
                        }
                    }
                });
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                clearBtn.textContent = originalText;
                clearBtn.disabled = false;
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert(`å·²æˆåŠŸæ¸…ç©ºï¼\n- äº‘ç«¯æ•°æ®å·²åˆ é™¤\n- ${clearedCount}ä¸ªé˜Ÿå‘˜ä½ç½®å·²é‡ç½®\n- æ‰€æœ‰ç”¨æˆ·å°†çœ‹åˆ°æ¸…ç©ºåçš„çŠ¶æ€`);
                
            } catch (err) {
                console.error('æ¸…ç©ºè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸:', err);
                alert('æ¸…ç©ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + err.message);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const clearBtn = document.getElementById('clearAllBtn');
                clearBtn.textContent = 'ä¸€é”®æ¸…ç©º';
                clearBtn.disabled = false;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', handleSave);
            });
            document.querySelectorAll('.del-btn').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });

            // ç»‘å®šä¿å­˜æŒ‰é’®äº‹ä»¶
            document.getElementById('headerSaveBtn').addEventListener('click', saveRaidSettings);
            
            // ç»‘å®šä¸€é”®æ¸…ç©ºæŒ‰é’®äº‹ä»¶
            document.getElementById('clearAllBtn').addEventListener('click', clearAllInputs);
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤å·²ä¿å­˜çš„æ•°æ®
        async function restoreSavedData() {
            try {
                // ä»äº‘ç«¯åŠ è½½æ‰“æœ¬è®¾ç½®
                const { data: settings, error: settingsError } = await supabase
                    .from('raid_settings')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .single();

                if (settingsError && settingsError.code !== 'PGRST116') {
                    console.error('ä»äº‘ç«¯åŠ è½½è®¾ç½®å¤±è´¥:', settingsError);
                    // äº‘ç«¯å¤±è´¥æ—¶ä»æœ¬åœ°åŠ è½½
                    loadRaidInfoFromLocal();
                } else if (settings) {
                    console.log('ä»äº‘ç«¯åŠ è½½æ‰“æœ¬è®¾ç½®æˆåŠŸ:', settings);
                    document.getElementById('daySelector').value = settings.day || 'å‘¨ä¸€';
                    document.getElementById('timeSelector').value = settings.time || '21:00';
                    document.getElementById('copySelector').value = settings.copy_type || 'åŒå';
                    document.getElementById('remarkInput').value = settings.remark || '';
                    // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                    localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                        day: settings.day || 'å‘¨ä¸€',
                        time: settings.time || '21:00',
                        copy: settings.copy_type || 'åŒå',
                        remark: settings.remark || ''
                    }));
                } else {
                    // äº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä»æœ¬åœ°åŠ è½½
                    loadRaidInfoFromLocal();
                }

                // ä»äº‘ç«¯åŠ è½½é˜Ÿå‘˜ä¿¡æ¯
                const { data: members, error: membersError } = await supabase
                    .from('team_members')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .order('created_at', { ascending: true });

                if (membersError) {
                    console.error('ä»äº‘ç«¯åŠ è½½é˜Ÿå‘˜å¤±è´¥:', membersError);
                    // äº‘ç«¯å¤±è´¥æ—¶ä»æœ¬åœ°åŠ è½½
                    loadMembersFromLocal();
                } else if (members && members.length > 0) {
                    console.log('ä»äº‘ç«¯åŠ è½½é˜Ÿå‘˜æˆåŠŸ:', members);
                    members.forEach(member => {
                        const item = document.querySelector(`[data-id="${member.position_id}"]`);
                        if (item) {
                            filledPositions[member.position_id] = member.member_name;
                            const input = item.querySelector('.input-box');
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');

                            if (input) {
                                const fixedText = document.createElement('div');
                                fixedText.className = 'fixed-text';
                                fixedText.textContent = member.member_name;
                                input.replaceWith(fixedText);
                                
                                if (saveBtn) saveBtn.style.display = 'none';
                                if (delBtn) delBtn.style.display = 'inline-block';
                            }
                            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                            localStorage.setItem(`${TEAM_KEY}_${member.position_id}`, member.member_name);
                        }
                    });
                } else {
                    // äº‘ç«¯æ²¡æœ‰æ•°æ®ï¼Œä»æœ¬åœ°åŠ è½½
                    loadMembersFromLocal();
                }
            } catch (err) {
                console.error('åŠ è½½æ•°æ®å¼‚å¸¸:', err);
                // ç½‘ç»œå¼‚å¸¸æ—¶ä»æœ¬åœ°åŠ è½½
                loadRaidInfoFromLocal();
                loadMembersFromLocal();
            }
        }

        // æœ¬åœ°æ•°æ®åŠ è½½å‡½æ•°
        function loadRaidInfoFromLocal() {
            const savedInfo = localStorage.getItem(RAID_SETTINGS_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('daySelector').value = info.day || 'å‘¨ä¸€';
                document.getElementById('timeSelector').value = info.time || '21:00';
                document.getElementById('copySelector').value = info.copy || 'åŒå';
                document.getElementById('remarkInput').value = info.remark || '';
            }
        }

        function loadMembersFromLocal() {
            document.querySelectorAll('.item').forEach(item => {
                const positionId = item.dataset.id;
                const savedName = localStorage.getItem(`${TEAM_KEY}_${positionId}`);
                
                if (savedName) {
                    filledPositions[positionId] = savedName;
                    const input = item.querySelector('.input-box');
                    const saveBtn = item.querySelector('.save-btn');
                    const delBtn = item.querySelector('.del-btn');

                    if (input) {
                        const fixedText = document.createElement('div');
                        fixedText.className = 'fixed-text';
                        fixedText.textContent = savedName;
                        input.replaceWith(fixedText);
                        
                        if (saveBtn) saveBtn.style.display = 'none';
                        if (delBtn) delBtn.style.display = 'inline-block';
                    }
                }
            });
        }

        // æ–¹æ¡ˆä¸€ï¼šå…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®
function showLocalDataFirst() {
    console.log('å¿«é€ŸåŠ è½½ï¼šæ˜¾ç¤ºæœ¬åœ°ç¼“å­˜æ•°æ®');
    
    // 1. ä»æœ¬åœ°åŠ è½½æ‰“æœ¬è®¾ç½®
    const savedInfo = localStorage.getItem(RAID_SETTINGS_KEY);
    if (savedInfo) {
        const info = JSON.parse(savedInfo);
        document.getElementById('daySelector').value = info.day || 'å‘¨ä¸€';
        document.getElementById('timeSelector').value = info.time || '21:00';
        document.getElementById('copySelector').value = info.copy || 'åŒå';
        document.getElementById('remarkInput').value = info.remark || '';
    }
    
    // 2. ä»æœ¬åœ°åŠ è½½é˜Ÿå‘˜ä¿¡æ¯
    document.querySelectorAll('.item').forEach(item => {
        const positionId = item.dataset.id;
        const savedName = localStorage.getItem(`${TEAM_KEY}_${positionId}`);
        
        if (savedName) {
            filledPositions[positionId] = savedName;
            const input = item.querySelector('.input-box');
            const saveBtn = item.querySelector('.save-btn');
            const delBtn = item.querySelector('.del-btn');

            if (input) {
                const fixedText = document.createElement('div');
                fixedText.className = 'fixed-text';
                fixedText.textContent = savedName;
                input.replaceWith(fixedText);
                
                if (saveBtn) saveBtn.style.display = 'none';
                if (delBtn) delBtn.style.display = 'inline-block';
            }
        }
    });
}

// å¼‚æ­¥åŠ è½½äº‘ç«¯æ•°æ®
async function loadCloudDataInBackground() {
    console.log('åå°åŠ è½½ï¼šå¼€å§‹è·å–äº‘ç«¯æœ€æ–°æ•°æ®');
    
    try {
        // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªè¯·æ±‚
        const [settingsResult, membersResult] = await Promise.allSettled([
            // 1. åŠ è½½æ‰“æœ¬è®¾ç½®
            supabase
                .from('raid_settings')
                .select('*')
                .eq('team_key', TEAM_KEY)
                .maybeSingle(),
            
            // 2. åŠ è½½é˜Ÿå‘˜ä¿¡æ¯
            supabase
                .from('team_members')
                .select('*')
                .eq('team_key', TEAM_KEY)
                .order('created_at', { ascending: true })
        ]);
        
        let hasUpdates = false;
        
        // å¤„ç†æ‰“æœ¬è®¾ç½®
        if (settingsResult.status === 'fulfilled' && settingsResult.value.data) {
            const settings = settingsResult.value.data;
            console.log('äº‘ç«¯è®¾ç½®åŠ è½½æˆåŠŸ:', settings);
            
            // æ¯”è¾ƒæœ¬åœ°å’Œäº‘ç«¯æ•°æ®ï¼Œå¦‚æœæœ‰æ›´æ–°åˆ™è¦†ç›–
            const localSettings = localStorage.getItem(RAID_SETTINGS_KEY);
            if (!localSettings || JSON.stringify(settings) !== localSettings) {
                document.getElementById('daySelector').value = settings.day || 'å‘¨ä¸€';
                document.getElementById('timeSelector').value = settings.time || '21:00';
                document.getElementById('copySelector').value = settings.copy_type || 'åŒå';
                document.getElementById('remarkInput').value = settings.remark || '';
                
                localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                    day: settings.day || 'å‘¨ä¸€',
                    time: settings.time || '21:00',
                    copy: settings.copy_type || 'åŒå',
                    remark: settings.remark || ''
                }));
                
                hasUpdates = true;
            }
        }
        
        // å¤„ç†é˜Ÿå‘˜ä¿¡æ¯
        if (membersResult.status === 'fulfilled' && membersResult.value.data) {
            const members = membersResult.value.data;
            console.log('äº‘ç«¯é˜Ÿå‘˜åŠ è½½æˆåŠŸ:', members.length, 'æ¡è®°å½•');
            
            members.forEach(member => {
                const localName = localStorage.getItem(`${TEAM_KEY}_${member.position_id}`);
                
                // å¦‚æœäº‘ç«¯æœ‰æ•°æ®è€Œæœ¬åœ°æ²¡æœ‰ï¼Œæˆ–è€…æ•°æ®ä¸åŒ
                if (member.member_name && localName !== member.member_name) {
                    const item = document.querySelector(`[data-id="${member.position_id}"]`);
                    if (item) {
                        const input = item.querySelector('.input-box');
                        const fixedText = item.querySelector('.fixed-text');
                        
                        if (input && member.member_name) {
                            const newFixedText = document.createElement('div');
                            newFixedText.className = 'fixed-text';
                            newFixedText.textContent = member.member_name;
                            input.replaceWith(newFixedText);
                            
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');
                            if (saveBtn) saveBtn.style.display = 'none';
                            if (delBtn) delBtn.style.display = 'inline-block';
                        } else if (fixedText && member.member_name) {
                            fixedText.textContent = member.member_name;
                        }
                        
                        localStorage.setItem(`${TEAM_KEY}_${member.position_id}`, member.member_name);
                        filledPositions[member.position_id] = member.member_name;
                        hasUpdates = true;
                    }
                }
            });
        }
        
            // æ›´æ–°è¿æ¥çŠ¶æ€
            const statusDiv = document.getElementById('connection-status');
            if (statusDiv) {
                statusDiv.innerHTML = 'âœ… å·²è¿æ¥åˆ°äº‘ç«¯';
                statusDiv.style.background = '#4CAF50';
                
                if (hasUpdates) {
                    // æ˜¾ç¤ºæ›´æ–°æç¤º
                    const updateNotice = document.createElement('div');
                    updateNotice.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: #2196F3; color: white; border-radius: 4px; font-size: 12px; z-index: 9999; animation: fadeInOut 5s ease;';
                    updateNotice.textContent = 'ğŸ” å·²åŒæ­¥äº‘ç«¯æœ€æ–°æ•°æ®';
                    document.body.appendChild(updateNotice);
                    
                    setTimeout(() => {
                        if (updateNotice.parentNode) {
                            updateNotice.parentNode.removeChild(updateNotice);
                        }
                    }, 5000);
                }
            }
            
        } catch (err) {
            console.error('åå°åŠ è½½å¤±è´¥:', err);
            
            // æ›´æ–°è¿æ¥çŠ¶æ€ä¸ºè­¦å‘Š
            const statusDiv = document.getElementById('connection-status');
            if (statusDiv) {
                statusDiv.innerHTML = 'âš ï¸ äº‘ç«¯è¿æ¥å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
                statusDiv.style.background = '#FF9800';
            }
        }
    }

        // å®æ—¶è®¢é˜…åŠŸèƒ½
        function setupRealtimeSubscription() {
            const channel = supabase
                .channel('team-changes')
                .on('postgres_changes', 
                    { 
                        event: '*',
                        schema: 'public', 
                        table: 'team_members',
                        filter: `team_key=eq.${TEAM_KEY}`
                    }, 
                    (payload) => {
                        console.log('é˜Ÿå‘˜æ•°æ®æœ‰å˜åŒ–:', payload);
                        // é‡æ–°åŠ è½½é˜Ÿå‘˜æ•°æ®
                        loadMembersFromCloud();
                    }
                )
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'raid_settings',
                        filter: `team_key=eq.${TEAM_KEY}`
                    },
                    (payload) => {
                        console.log('æ‰“æœ¬è®¾ç½®æœ‰å˜åŒ–:', payload);
                        // é‡æ–°åŠ è½½æ‰“æœ¬è®¾ç½®
                        loadRaidSettingsFromCloud();
                    }
                )
                .subscribe((status) => {
                    console.log('å®æ—¶è®¢é˜…çŠ¶æ€:', status);
                });

            return channel;
        }

        // ä»äº‘ç«¯åŠ è½½é˜Ÿå‘˜æ•°æ®
        async function loadMembersFromCloud() {
            try {
                const { data: members, error } = await supabase
                    .from('team_members')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .order('created_at', { ascending: true });

                if (!error && members) {
                    members.forEach(member => {
                        const item = document.querySelector(`[data-id="${member.position_id}"]`);
                        if (item) {
                            const input = item.querySelector('.input-box');
                            const fixedText = item.querySelector('.fixed-text');
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');
                            
                            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¾“å…¥æ¡†ï¼Œä¸”äº‘ç«¯æœ‰æ•°æ®ï¼Œåˆ™æ›´æ–°ä¸ºå›ºå®šæ–‡æœ¬
                            if (input && member.member_name) {
                                const newFixedText = document.createElement('div');
                                newFixedText.className = 'fixed-text';
                                newFixedText.textContent = member.member_name;
                                input.replaceWith(newFixedText);
                                
                                if (saveBtn) saveBtn.style.display = 'none';
                                if (delBtn) delBtn.style.display = 'inline-block';
                            }
                            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯å›ºå®šæ–‡æœ¬ï¼Œæ›´æ–°å†…å®¹
                            else if (fixedText && member.member_name) {
                                fixedText.textContent = member.member_name;
                            }
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem(`${TEAM_KEY}_${member.position_id}`, member.member_name);
                            filledPositions[member.position_id] = member.member_name;
                        }
                    });
                }
            } catch (err) {
                console.error('å®æ—¶æ›´æ–°é˜Ÿå‘˜æ•°æ®å¤±è´¥:', err);
            }
        }

        // ä»äº‘ç«¯åŠ è½½æ‰“æœ¬è®¾ç½®
        async function loadRaidSettingsFromCloud() {
            try {
                const { data: settings, error } = await supabase
                    .from('raid_settings')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .single();

                if (!error && settings) {
                    document.getElementById('daySelector').value = settings.day || 'å‘¨ä¸€';
                    document.getElementById('timeSelector').value = settings.time || '21:00';
                    document.getElementById('copySelector').value = settings.copy_type || 'åŒå';
                    document.getElementById('remarkInput').value = settings.remark || '';
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                        day: settings.day || 'å‘¨ä¸€',
                        time: settings.time || '21:00',
                        copy: settings.copy_type || 'åŒå',
                        remark: settings.remark || ''
                    }));
                }
            } catch (err) {
                console.error('å®æ—¶æ›´æ–°æ‰“æœ¬è®¾ç½®å¤±è´¥:', err);
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // 1. ç«‹å³æ‰§è¡Œæ— éœ€ç­‰å¾…çš„æ“ä½œ
            generateTimeOptions();
            initEventListeners();
            
            // 2. ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const connectionStatus = document.createElement('div');
            connectionStatus.id = 'connection-status';
            connectionStatus.style.cssText = 'position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background: #FF9800; color: white; border-radius: 4px; font-size: 12px; z-index: 9999;';
            connectionStatus.textContent = 'ğŸ”„ æ­£åœ¨è¿æ¥äº‘ç«¯...';
            document.body.appendChild(connectionStatus);
            
            // 3. å¹¶è¡ŒåŠ è½½ï¼šå…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®ï¼Œå†å¼‚æ­¥åŠ è½½äº‘ç«¯æ•°æ®
            showLocalDataFirst();
            
            // 4. å¼‚æ­¥åŠ è½½äº‘ç«¯æ•°æ®ï¼ˆä¸é˜»å¡ç•Œé¢ï¼‰
            loadCloudDataInBackground();
            
            // 5. è®¾ç½®å®æ—¶è®¢é˜…
            setupRealtimeSubscription();
        });
    </script>
</body>
</html>