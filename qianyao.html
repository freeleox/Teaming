<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报名双十 - 梳风弄弦音</title>
    <style>
        /* 阿里妈妈东方大楷字体声明 */
        @font-face {
        font-family: 'AlimamaDongFangDaKai';
        src: url('fonts/AlimamaDongFangDaKai-Regular.otf') format('opentype'),
            url('fonts/AlimamaDongFangDaKai-Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'AlimamaDongFangDaKai', "SimHei", "Microsoft YaHei", sans-serif;     /* 修改为阿里妈妈 */
        }

        body {
            background-color: #f9f7f3;
            color: #5a4b38;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* 标题区 */
        .page-header {
            text-align: center;
            padding: 50px 0 30px;
            border-bottom: 1px solid #e0d8c8;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 2.2rem;
            color: #5a4b38;
            font-weight: 400;
            letter-spacing: 6px;
        }

        .team-name {
            margin-top: 8px;
            font-size: 1rem;
            color: #8a7d6b;
        }

        /* 队长填写区域标题 */
        .raid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #9a8868;
        }

        .raid-title {
            font-size: 1.2rem;
            color: #5a4b38;
            font-weight: 500;
        }

        .header-save-btn {
            padding: 8px 20px;
            background-color: #9a8868;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background-color 0.3s;
            margin-left: 15px; /* 增加左侧间距 */
        }

        .header-save-btn:hover {
            background-color: #867352;
        }

        /* 打本信息栏样式 */
        .raid-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0d8c8;
            flex-wrap: wrap;
        }

        .info-item {
            flex: 1;
            min-width: 180px;
        }

        .info-label {
            display: block;
            font-size: 0.9rem;
            color: #8a7d6b;
            margin-bottom: 6px;
        }

        .day-select, .time-select, .copy-select, .remark-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0d8c8;
            border-radius: 6px;
            font-size: 1rem;
            background: #fefbf7;
            outline: none;
            color: #5a4b38;
        }

        .day-select:focus, .time-select:focus, .copy-select:focus, .remark-input:focus {
            border-color: #9a8868;
        }

        /* 列表项 */
        .item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 14px 18px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0d8c8;
        }

        .prefix {
            width: 100px;
            font-size: 1rem;
            color: #5a4b38;
            font-weight: 500;
        }

        .fixed-text {
            font-size: 1rem;
            color: #5a4b38;
        }

        .input-box {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0d8c8;
            border-radius: 6px;
            font-size: 1rem;
            background: #fefbf7;
            outline: none;
        }

        .input-box:focus {
            border-color: #9a8868;
        }

        /* 按钮 */
        .btn {
            margin-left: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .save-btn {
            background: #9a8868;
            color: #fff;
        }

        .del-btn {
            background: #c9b89f;
            color: #fff;
        }

        /* 提示框样式 */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #d64141;
            color: white;
            border-radius: 6px;
            z-index: 9999;
            display: none;
            animation: fadeInOut 3s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            80% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .raid-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-save-btn {
                margin-left: 0;
                margin-top: 10px; /* 增加上方间距 */
                width: auto; /* 不要全宽度 */
                min-width: 120px; /* 设置最小宽度 */
                align-self: flex-end;
            }
            
            .raid-info {
                flex-direction: column;
                gap: 12px;
            }

            .info-item {
                min-width: 100%;
            }

            .item {
                flex-wrap: wrap;
            }
            .prefix {
                width: 80px;
                margin-bottom: 8px;
            }
            .input-box {
                width: 100%;
                margin-bottom: 8px;
            }
            .btn {
                margin-left: 0;
                margin-right: 8px;
                margin-top: 8px;   /* 添加上方外边距，与输入框保持距离 */
            }
            
            /* 新增：确保保存按钮和删除按钮在同一位置 */
            .save-btn, .del-btn {
                margin-left: 8px;
                margin-right: 8px;
                margin-top: 8px;
            }
            
            /* 可选：为按钮容器添加flex布局，使按钮排列更整齐 */
            .item {
                position: relative;
            }
            
            .btn {
                display: inline-block;
            }
        }
    </style>
    
    <!-- Supabase客户端初始化 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script>
        // 替换为您的实际Supabase项目URL和Anon Key
        const SUPABASE_URL = 'https://jtxbzkfnpbrjmlqinogj.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_0K0RV2KcU7DkuSxF9t73dA_a8pIZnB3';
        
        // 创建Supabase客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 测试连接
        supabase.from('team_members').select('*').limit(1)
            .then(response => {
                console.log('Supabase连接成功:', response);
            })
            .catch(error => {
                console.error('Supabase连接失败:', error);
            });
    </script>
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">报名双十</h1>
            <div class="team-name">队伍：千瑶</div>
        </div>

        <!-- 提示框 -->
        <div class="alert" id="alertBox">该位置已经被填写！请在下方重新填写。</div>

        <!-- 打本信息栏（队长行上方） -->
        <div class="raid-header">
            <div class="raid-title">本栏仅队长填写，保存生效</div>
            <button class="header-save-btn" id="headerSaveBtn">保存设置</button>
        </div>
        
        <div class="raid-info" id="raidInfo">
            <!-- 星期选择器 -->
            <div class="info-item">
                <label class="info-label">选择星期</label>
                <select class="day-select" id="daySelector">
                    <option value="周一">周一</option>
                    <option value="周二">周二</option>
                    <option value="周三">周三</option>
                    <option value="周四">周四</option>
                    <option value="周五">周五</option>
                    <option value="周六">周六</option>
                    <option value="周日">周日</option>
                </select>
            </div>

            <!-- 打本时间选择器 -->
            <div class="info-item">
                <label class="info-label">打本时间</label>
                <select class="time-select" id="timeSelector">
                    <!-- 自动生成0~24:00，半小时为单位的选项 -->
                </select>
            </div>

            <!-- 副本选择下拉菜单 -->
            <div class="info-item">
                <label class="info-label">副本选择</label>
                <select class="copy-select" id="copySelector">
                    <option value="双十">双十</option>
                    <option value="开荒">开荒</option>
                </select>
            </div>

            <!-- 备注输入框 -->
            <div class="info-item">
                <label class="info-label">队长有什么想说的吗：</label>
                <input type="text" class="remark-input" id="remarkInput" placeholder="请输入">
            </div>
        </div>

        <div class="raid-header" style="margin-top: 30px;">
            <div class="raid-title">队员填写，保存生效</div>
            <button class="header-save-btn" id="clearAllBtn">一键清空</button>
        </div>

        <!-- 队长（固定） -->
        <div class="item">
            <div class="prefix">队长</div>
            <div class="fixed-text">千瑶</div>
        </div>

        <!-- 队员 1-7、纯奶位 1-2 结构不变 -->
        <div class="item" data-id="member1">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member2">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member3">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member4">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member5">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member6">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="member7">
            <div class="prefix">队员</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="milk1">
            <div class="prefix">纯奶位</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
        <div class="item" data-id="milk2">
            <div class="prefix">纯奶位</div>
            <input type="text" class="input-box" placeholder="请队员自行填写后保存">
            <button class="btn save-btn">保存</button>
            <button class="btn del-btn" style="display: none;">删除</button>
        </div>
    </div>

    <script>
        // 存储已填写的位置信息
        const filledPositions = {};
        const alertBox = document.getElementById('alertBox');
        const TEAM_KEY = 'qianyao'; // 千队伍标识
        const RAID_SETTINGS_KEY = `${TEAM_KEY}_raid_settings`; // 打本设置存储键

        // 生成时间选择器选项（0~24:00，半小时为单位）
        function generateTimeOptions() {
            const timeSelector = document.getElementById('timeSelector');
            
            // 首先添加"百业派对后"选项并设置为默认选中
            const afterPartyOption = document.createElement('option');
            afterPartyOption.value = '百业派对后';
            afterPartyOption.textContent = '百业派对后';
            afterPartyOption.selected = true;
            timeSelector.appendChild(afterPartyOption);
            
            // 添加分隔线选项（可选）
            const separatorOption = document.createElement('option');
            separatorOption.disabled = true;
            separatorOption.textContent = '──────────';
            timeSelector.appendChild(separatorOption);
            
            let hours = 0;
            let minutes = 0;

            // 生成00:00到24:00的选项，步长30分钟
            while (hours <= 24) {
                const hourStr = hours.toString().padStart(2, '0');
                const minStr = minutes.toString().padStart(2, '0');
                const timeStr = `${hourStr}:${minStr}`;
                
                const option = document.createElement('option');
                option.value = timeStr;
                option.textContent = timeStr;
                timeSelector.appendChild(option);

                minutes += 30;
                if (minutes >= 60) {
                    minutes = 0;
                    hours += 1;
                }
            }
        }

        // 加载保存的打本信息
        function loadRaidInfo() {
            const savedInfo = localStorage.getItem(RAID_SETTINGS_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                if (info.day) document.getElementById('daySelector').value = info.day;
                if (info.time) document.getElementById('timeSelector').value = info.time;
                if (info.copy) document.getElementById('copySelector').value = info.copy;
                if (info.remark) document.getElementById('remarkInput').value = info.remark;
            } else {
                // 默认设置：周一 21:00 双十
                document.getElementById('daySelector').value = '周一';
                document.getElementById('timeSelector').value = '21:00';
                document.getElementById('copySelector').value = '双十';
            }
        }

        // 保存打本设置
        async function saveRaidSettings() {
            const saveBtn = document.getElementById('headerSaveBtn');
            const raidSettings = {
                day: document.getElementById('daySelector').value,
                time: document.getElementById('timeSelector').value,
                copy_type: document.getElementById('copySelector').value,
                remark: document.getElementById('remarkInput').value
            };
            
            // 1. 立即保存到本地
            localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                day: raidSettings.day,
                time: raidSettings.time,
                copy: raidSettings.copy_type,
                remark: raidSettings.remark
            }));
            
            try {
                // 2. 先检查是否存在记录
                const { data: existingRecord, error: checkError } = await supabase
                    .from('raid_settings')
                    .select('id')
                    .eq('team_key', TEAM_KEY)
                    .maybeSingle();
                
                let result;
                
                if (checkError) {
                    console.warn('检查记录时出错:', checkError);
                }
                
                // 3. 根据是否存在记录选择操作
                if (existingRecord) {
                    // 更新现有记录
                    const { data, error } = await supabase
                        .from('raid_settings')
                        .update({
                            day: raidSettings.day,
                            time: raidSettings.time,
                            copy_type: raidSettings.copy_type,
                            remark: raidSettings.remark,
                            updated_at: new Date().toISOString()
                        })
                        .eq('team_key', TEAM_KEY)
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    console.log('更新成功:', data);
                } else {
                    // 插入新记录
                    const { data, error } = await supabase
                        .from('raid_settings')
                        .insert({
                            team_key: TEAM_KEY,
                            day: raidSettings.day,
                            time: raidSettings.time,
                            copy_type: raidSettings.copy_type,
                            remark: raidSettings.remark,
                            updated_at: new Date().toISOString()
                        })
                        .select();
                    
                    if (error) throw error;
                    result = data;
                    console.log('插入成功:', data);
                }
                
                // 4. 显示成功反馈
                const originalText = saveBtn.textContent;
                const originalColor = saveBtn.style.color || '#000000';
                const originalBackground = saveBtn.style.backgroundColor;
                
                saveBtn.textContent = "已保存";
                saveBtn.style.color = "#4CAF50";
                saveBtn.style.backgroundColor = "#e8f5e9";
                
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.color = originalColor;
                    saveBtn.style.backgroundColor = originalBackground;
                }, 3000);
                
                alert('设置已保存到云端！');
                return result;
                
            } catch (err) {
                console.error('保存失败:', err);
                
                // 显示错误状态
                saveBtn.textContent = "保存失败";
                saveBtn.style.color = "#f44336";
                saveBtn.style.backgroundColor = "#ffebee";
                
                setTimeout(() => {
                    saveBtn.textContent = "保存设置";
                    saveBtn.style.color = "";
                    saveBtn.style.backgroundColor = "";
                }, 3000);
                
                alert('云端保存失败，但设置已保存到本地');
            }
        }

        // 显示提示框
        function showAlert() {
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }

        // 保存队员功能
        async function handleSave(event) {
            const btn = event.target;
            const item = btn.closest('.item');
            const input = item.querySelector('.input-box');
            const delBtn = item.querySelector('.del-btn');
            const positionId = item.dataset.id;

            const name = input.value.trim();
            if (!name) {
                alert('请输入名字后再保存！');
                return;
            }

            if (filledPositions[positionId]) {
                showAlert();
                input.value = '';
                return;
            }

            try {
                // 保存到Supabase云端数据库
                const { data, error } = await supabase
                    .from('team_members')
                    .upsert({
                        team_key: TEAM_KEY,
                        position_id: positionId,
                        member_name: name
                    })
                    .select();

                if (error) {
                    console.error('保存到云端失败:', error);
                    localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                    alert('网络连接失败，已保存到本地');
                } else {
                    console.log('保存到云端成功:', data);
                    localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                }
            } catch (err) {
                console.error('保存异常:', err);
                localStorage.setItem(`${TEAM_KEY}_${positionId}`, name);
                alert('网络异常，已保存到本地');
            }

            filledPositions[positionId] = name;

            const fixedText = document.createElement('div');
            fixedText.className = 'fixed-text';
            fixedText.textContent = name;
            input.replaceWith(fixedText);

            btn.style.display = 'none';
            delBtn.style.display = 'inline-block';
        }

        // 删除队员功能
        async function handleDelete(event) {
            const btn = event.target;
            const item = btn.closest('.item');
            const fixedText = item.querySelector('.fixed-text');
            const saveBtn = item.querySelector('.save-btn');
            const positionId = item.dataset.id;

            try {
                // 从云端删除
                const { error } = await supabase
                    .from('team_members')
                    .delete()
                    .eq('team_key', TEAM_KEY)
                    .eq('position_id', positionId);

                if (error) {
                    console.error('从云端删除失败:', error);
                } else {
                    console.log('从云端删除成功');
                }
            } catch (err) {
                console.error('删除异常:', err);
            }

            // 无论云端是否成功，都删除本地数据
            delete filledPositions[positionId];
            localStorage.removeItem(`${TEAM_KEY}_${positionId}`);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-box';
            input.placeholder = '请队员自行填写后保存';
            fixedText.replaceWith(input);

            btn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        }

        // 清空所有队员填写的内容
        async function clearAllInputs() {
            if (!confirm('确定要清空所有队员填写的内容吗？此操作会从云端永久删除数据，不可撤销。')) {
                return;
            }
            
            try {
                // 显示加载状态
                const clearBtn = document.getElementById('clearAllBtn');
                const originalText = clearBtn.textContent;
                clearBtn.textContent = '清空中...';
                clearBtn.disabled = true;
                
                // 第一步：从云端删除所有相关数据
                console.log('开始从云端删除数据...');
                
                // 1. 删除 team_members 表中该队伍的所有记录
                const { error: membersError } = await supabase
                    .from('team_members')
                    .delete()
                    .eq('team_key', TEAM_KEY);
                
                if (membersError) {
                    console.error('删除云端队员数据失败:', membersError);
                    alert('删除云端队员数据失败: ' + membersError.message);
                    clearBtn.textContent = originalText;
                    clearBtn.disabled = false;
                    return;
                }
                
                console.log('云端队员数据删除成功');
                
                // 第二步：清除本地数据和界面
                const items = document.querySelectorAll('.item');
                let clearedCount = 0;
                
                items.forEach(item => {
                    const positionId = item.dataset.id;
                    
                    // 仅处理队员和奶位（有data-id的项目）
                    if (positionId && (positionId.startsWith('member') || positionId.startsWith('milk'))) {
                        // 删除本地存储
                        localStorage.removeItem(`${TEAM_KEY}_${positionId}`);
                        
                        // 清除内存记录
                        delete filledPositions[positionId];
                        
                        // 找到输入框并清除
                        const inputBox = item.querySelector('.input-box');
                        if (inputBox) {
                            inputBox.value = '';
                        }
                        
                        // 如果已经保存，需要重置为可编辑状态
                        const fixedText = item.querySelector('.fixed-text');
                        if (fixedText) {
                            // 创建新的输入框
                            const newInput = document.createElement('input');
                            newInput.type = 'text';
                            newInput.className = 'input-box';
                            newInput.placeholder = '请队员自行填写后保存';
                            
                            // 替换fixed-text
                            fixedText.replaceWith(newInput);
                            
                            // 显示保存按钮，隐藏删除按钮
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');
                            if (saveBtn) saveBtn.style.display = 'inline-block';
                            if (delBtn) delBtn.style.display = 'none';
                            
                            clearedCount++;
                        }
                    }
                });
                
                // 恢复按钮状态
                clearBtn.textContent = originalText;
                clearBtn.disabled = false;
                
                // 显示成功提示
                alert(`已成功清空！\n- 云端数据已删除\n- ${clearedCount}个队员位置已重置\n- 所有用户将看到清空后的状态`);
                
            } catch (err) {
                console.error('清空过程中发生异常:', err);
                alert('清空过程中发生错误: ' + err.message);
                
                // 恢复按钮状态
                const clearBtn = document.getElementById('clearAllBtn');
                clearBtn.textContent = '一键清空';
                clearBtn.disabled = false;
            }
        }

        // 初始化事件监听
        function initEventListeners() {
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', handleSave);
            });
            document.querySelectorAll('.del-btn').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });

            // 绑定保存按钮事件
            document.getElementById('headerSaveBtn').addEventListener('click', saveRaidSettings);
            
            // 绑定一键清空按钮事件
            document.getElementById('clearAllBtn').addEventListener('click', clearAllInputs);
        }

        // 页面加载时恢复已保存的数据
        async function restoreSavedData() {
            try {
                // 从云端加载打本设置
                const { data: settings, error: settingsError } = await supabase
                    .from('raid_settings')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .single();

                if (settingsError && settingsError.code !== 'PGRST116') {
                    console.error('从云端加载设置失败:', settingsError);
                    // 云端失败时从本地加载
                    loadRaidInfoFromLocal();
                } else if (settings) {
                    console.log('从云端加载打本设置成功:', settings);
                    document.getElementById('daySelector').value = settings.day || '周一';
                    document.getElementById('timeSelector').value = settings.time || '21:00';
                    document.getElementById('copySelector').value = settings.copy_type || '双十';
                    document.getElementById('remarkInput').value = settings.remark || '';
                    // 保存到本地缓存
                    localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                        day: settings.day || '周一',
                        time: settings.time || '21:00',
                        copy: settings.copy_type || '双十',
                        remark: settings.remark || ''
                    }));
                } else {
                    // 云端没有数据，从本地加载
                    loadRaidInfoFromLocal();
                }

                // 从云端加载队员信息
                const { data: members, error: membersError } = await supabase
                    .from('team_members')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .order('created_at', { ascending: true });

                if (membersError) {
                    console.error('从云端加载队员失败:', membersError);
                    // 云端失败时从本地加载
                    loadMembersFromLocal();
                } else if (members && members.length > 0) {
                    console.log('从云端加载队员成功:', members);
                    members.forEach(member => {
                        const item = document.querySelector(`[data-id="${member.position_id}"]`);
                        if (item) {
                            filledPositions[member.position_id] = member.member_name;
                            const input = item.querySelector('.input-box');
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');

                            if (input) {
                                const fixedText = document.createElement('div');
                                fixedText.className = 'fixed-text';
                                fixedText.textContent = member.member_name;
                                input.replaceWith(fixedText);
                                
                                if (saveBtn) saveBtn.style.display = 'none';
                                if (delBtn) delBtn.style.display = 'inline-block';
                            }
                            // 保存到本地缓存
                            localStorage.setItem(`${TEAM_KEY}_${member.position_id}`, member.member_name);
                        }
                    });
                } else {
                    // 云端没有数据，从本地加载
                    loadMembersFromLocal();
                }
            } catch (err) {
                console.error('加载数据异常:', err);
                // 网络异常时从本地加载
                loadRaidInfoFromLocal();
                loadMembersFromLocal();
            }
        }

        // 本地数据加载函数
        function loadRaidInfoFromLocal() {
            const savedInfo = localStorage.getItem(RAID_SETTINGS_KEY);
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('daySelector').value = info.day || '周一';
                document.getElementById('timeSelector').value = info.time || '21:00';
                document.getElementById('copySelector').value = info.copy || '双十';
                document.getElementById('remarkInput').value = info.remark || '';
            }
        }

        function loadMembersFromLocal() {
            document.querySelectorAll('.item').forEach(item => {
                const positionId = item.dataset.id;
                const savedName = localStorage.getItem(`${TEAM_KEY}_${positionId}`);
                
                if (savedName) {
                    filledPositions[positionId] = savedName;
                    const input = item.querySelector('.input-box');
                    const saveBtn = item.querySelector('.save-btn');
                    const delBtn = item.querySelector('.del-btn');

                    if (input) {
                        const fixedText = document.createElement('div');
                        fixedText.className = 'fixed-text';
                        fixedText.textContent = savedName;
                        input.replaceWith(fixedText);
                        
                        if (saveBtn) saveBtn.style.display = 'none';
                        if (delBtn) delBtn.style.display = 'inline-block';
                    }
                }
            });
        }

        // 实时订阅功能
        function setupRealtimeSubscription() {
            const channel = supabase
                .channel('team-changes')
                .on('postgres_changes', 
                    { 
                        event: '*',
                        schema: 'public', 
                        table: 'team_members',
                        filter: `team_key=eq.${TEAM_KEY}`
                    }, 
                    (payload) => {
                        console.log('队员数据有变化:', payload);
                        // 重新加载队员数据
                        loadMembersFromCloud();
                    }
                )
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'raid_settings',
                        filter: `team_key=eq.${TEAM_KEY}`
                    },
                    (payload) => {
                        console.log('打本设置有变化:', payload);
                        // 重新加载打本设置
                        loadRaidSettingsFromCloud();
                    }
                )
                .subscribe((status) => {
                    console.log('实时订阅状态:', status);
                });

            return channel;
        }

        // 从云端加载队员数据
        async function loadMembersFromCloud() {
            try {
                const { data: members, error } = await supabase
                    .from('team_members')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .order('created_at', { ascending: true });

                if (!error && members) {
                    members.forEach(member => {
                        const item = document.querySelector(`[data-id="${member.position_id}"]`);
                        if (item) {
                            const input = item.querySelector('.input-box');
                            const fixedText = item.querySelector('.fixed-text');
                            const saveBtn = item.querySelector('.save-btn');
                            const delBtn = item.querySelector('.del-btn');
                            
                            // 如果当前显示的是输入框，且云端有数据，则更新为固定文本
                            if (input && member.member_name) {
                                const newFixedText = document.createElement('div');
                                newFixedText.className = 'fixed-text';
                                newFixedText.textContent = member.member_name;
                                input.replaceWith(newFixedText);
                                
                                if (saveBtn) saveBtn.style.display = 'none';
                                if (delBtn) delBtn.style.display = 'inline-block';
                            }
                            // 如果当前显示的是固定文本，更新内容
                            else if (fixedText && member.member_name) {
                                fixedText.textContent = member.member_name;
                            }
                            
                            // 更新本地存储
                            localStorage.setItem(`${TEAM_KEY}_${member.position_id}`, member.member_name);
                            filledPositions[member.position_id] = member.member_name;
                        }
                    });
                }
            } catch (err) {
                console.error('实时更新队员数据失败:', err);
            }
        }

        // 从云端加载打本设置
        async function loadRaidSettingsFromCloud() {
            try {
                const { data: settings, error } = await supabase
                    .from('raid_settings')
                    .select('*')
                    .eq('team_key', TEAM_KEY)
                    .single();

                if (!error && settings) {
                    document.getElementById('daySelector').value = settings.day || '周一';
                    document.getElementById('timeSelector').value = settings.time || '21:00';
                    document.getElementById('copySelector').value = settings.copy_type || '双十';
                    document.getElementById('remarkInput').value = settings.remark || '';
                    
                    // 更新本地存储
                    localStorage.setItem(RAID_SETTINGS_KEY, JSON.stringify({
                        day: settings.day || '周一',
                        time: settings.time || '21:00',
                        copy: settings.copy_type || '双十',
                        remark: settings.remark || ''
                    }));
                }
            } catch (err) {
                console.error('实时更新打本设置失败:', err);
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', async () => {
            generateTimeOptions();
            initEventListeners();
            
            // 首先尝试从云端加载数据
            await restoreSavedData();
            
            // 设置实时订阅
            setupRealtimeSubscription();
            
            // 显示连接状态
            const connectionStatus = document.createElement('div');
            connectionStatus.id = 'connection-status';
            connectionStatus.style.cssText = 'position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background: #4CAF50; color: white; border-radius: 4px; font-size: 12px;';
            connectionStatus.textContent = '✓ 已连接到云端';
            document.body.appendChild(connectionStatus);
        });
    </script>
</body>
</html>